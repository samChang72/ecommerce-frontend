<!DOCTYPE html>
<html>
<head>
<title>GTM-DataLayer-Integration.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="gtm-data-layer-%E6%95%B4%E5%90%88%E8%AA%AA%E6%98%8E%E6%96%87%E4%BB%B6">GTM Data Layer 整合說明文件</h1>
<h2 id="%F0%9F%93%8B-%E6%A6%82%E8%BF%B0">📋 概述</h2>
<p>本文件說明如何在 Vue.js 電商網站中整合 Google Tag Manager (GTM) 的 Data Layer，以追蹤使用者的購物行為，包括加入購物車、移除商品、查看商品和開始結帳等事件。</p>
<h2 id="%F0%9F%94%84-%E8%B3%87%E6%96%99%E6%B5%81%E7%A8%8B">🔄 資料流程</h2>
<pre class="hljs"><code><div>使用者操作 → Vue.js 事件處理 → Data Layer 推送 → GTM 接收 → 第三方追蹤工具 (Facebook Pixel, OneAD Pixel 等)
</div></code></pre>
<h2 id="%F0%9F%93%8A-data-layer-%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B">📊 Data Layer 資料結構</h2>
<h3 id="%E6%A8%99%E6%BA%96%E9%9B%BB%E5%95%86%E4%BA%8B%E4%BB%B6%E6%A0%BC%E5%BC%8F-%E7%AC%A6%E5%90%88-ga4-%E8%A6%8F%E7%AF%84">標準電商事件格式 (符合 GA4 規範)</h3>
<pre class="hljs"><code><div><span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">ecommerce</span>: {
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-number">30.00</span>,
    <span class="hljs-attr">items</span>: [{
      <span class="hljs-attr">item_id</span>: <span class="hljs-string">'1'</span>,
      <span class="hljs-attr">item_name</span>: <span class="hljs-string">'可樂'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'飲料'</span>,
      <span class="hljs-attr">price</span>: <span class="hljs-number">30.00</span>,
      <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span>
    }]
  }
})
</div></code></pre>
<h2 id="%F0%9F%92%BB-%E7%A8%8B%E5%BC%8F%E5%AF%A6%E4%BD%9C%E7%AF%84%E4%BE%8B">💻 程式實作範例</h2>
<h3 id="1-%E9%A6%96%E9%A0%81---%E5%8A%A0%E5%85%A5%E8%B3%BC%E7%89%A9%E8%BB%8A-homepagevue">1. 首頁 - 加入購物車 (HomePage.vue)</h3>
<pre class="hljs"><code><div>&lt;template&gt;
  &lt;div class=&quot;homepage&quot;&gt;
    &lt;!-- 產品列表 --&gt;
    &lt;div class=&quot;products&quot;&gt;
      &lt;ul&gt;
        &lt;li v-for=&quot;product in filteredProducts&quot; :key=&quot;product.id&quot; class=&quot;product-item&quot;&gt;
          &lt;img :src=&quot;product.image&quot; :alt=&quot;product.name&quot; class=&quot;product-image&quot; /&gt;
          &lt;div class=&quot;product-info&quot;&gt;
            &lt;strong&gt;{{ product.name }}&lt;/strong&gt;
            &lt;p class=&quot;price&quot;&gt;價格: ${{ product.price }}&lt;/p&gt;
          &lt;/div&gt;
          &lt;!-- 加入購物車按鈕 --&gt;
          &lt;button @click=&quot;addToCart(product)&quot; class=&quot;add-to-cart-btn&quot;&gt;
            加入購物車
          &lt;/button&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import { ref, computed } from 'vue'
import { useCartStore } from '../store/cart'
import productsData from '../assets/products.json'

export default {
  name: 'HomePage',
  setup() {
    const cartStore = useCartStore()
    
    // 加入購物車功能
    const addToCart = (product) =&gt; {
      // 1. 更新購物車狀態
      cartStore.addToCart(product)
      
      // 2. 發送 GTM 事件到 Data Layer
      if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
        window.dataLayer.push({
          event: 'add_to_cart',
          ecommerce: {
            currency: 'USD',
            value: parseFloat(product.price),
            items: [{
              item_id: product.id.toString(),
              item_name: product.name,
              category: product.type,
              price: parseFloat(product.price),
              quantity: 1
            }]
          }
        })
        
        // 3. Debug 日誌
        console.log('GTM add_to_cart event sent:', {
          item_name: product.name,
          item_id: product.id,
          price: product.price,
          category: product.type
        })
      }
      
      // 4. 使用者回饋
      alert(`${product.name} 已加入購物車！`)
    }
    
    return {
      addToCart
      // ... 其他返回值
    }
  }
}
&lt;/script&gt;
</div></code></pre>
<h3 id="2-%E7%94%A2%E5%93%81%E9%A0%81%E9%9D%A2---%E6%9F%A5%E7%9C%8B%E5%95%86%E5%93%81%E8%88%87%E5%8A%A0%E5%85%A5%E8%B3%BC%E7%89%A9%E8%BB%8A-productpagevue">2. 產品頁面 - 查看商品與加入購物車 (ProductPage.vue)</h3>
<pre class="hljs"><code><div>&lt;script&gt;
import { computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useCartStore } from '../store/cart'
import productsData from '../assets/products.json'

export default {
  name: 'ProductPage',
  setup() {
    const route = useRoute()
    const cartStore = useCartStore()
    
    const product = computed(() =&gt; {
      const productId = parseInt(route.params.id)
      return productsData.find(p =&gt; p.id === productId)
    })
    
    // 當頁面載入時發送查看商品事件
    onMounted(() =&gt; {
      if (product.value &amp;&amp; typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
        window.dataLayer.push({
          event: 'view_item',
          ecommerce: {
            currency: 'USD',
            value: parseFloat(product.value.price),
            items: [{
              item_id: product.value.id.toString(),
              item_name: product.value.name,
              category: product.value.type,
              price: parseFloat(product.value.price),
              quantity: 1
            }]
          }
        })
        
        console.log('GTM view_item event sent:', {
          item_name: product.value.name,
          item_id: product.value.id,
          price: product.value.price
        })
      }
    })
    
    // 加入購物車
    const handleAddToCart = () =&gt; {
      if (product.value) {
        cartStore.addToCart(product.value)
        
        // 發送 GTM 事件
        if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
          window.dataLayer.push({
            event: 'add_to_cart',
            ecommerce: {
              currency: 'USD',
              value: parseFloat(product.value.price),
              items: [{
                item_id: product.value.id.toString(),
                item_name: product.value.name,
                category: product.value.type,
                price: parseFloat(product.value.price),
                quantity: 1
              }]
            }
          })
          
          console.log('GTM add_to_cart event sent from ProductPage')
        }
        
        alert(`${product.value.name} 已加入購物車！`)
      }
    }
    
    return {
      product,
      handleAddToCart
    }
  }
}
&lt;/script&gt;
</div></code></pre>
<h3 id="3-%E8%B3%BC%E7%89%A9%E8%BB%8A%E9%A0%81%E9%9D%A2---%E7%A7%BB%E9%99%A4%E5%95%86%E5%93%81%E8%88%87%E9%96%8B%E5%A7%8B%E7%B5%90%E5%B8%B3-cartpagevue">3. 購物車頁面 - 移除商品與開始結帳 (CartPage.vue)</h3>
<pre class="hljs"><code><div>&lt;script setup&gt;
import { computed } from 'vue'
import { useRouter } from 'vue-router'
import { useCartStore } from '../store/cart.js'

const router = useRouter()
const cartStore = useCartStore()
const { items } = cartStore

// 移除購物車商品
const removeFromCart = (itemId) =&gt; {
  const itemToRemove = items.find(item =&gt; item.id === itemId)
  
  if (itemToRemove) {
    // 發送 GTM 事件 - 移除商品
    if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
      window.dataLayer.push({
        event: 'remove_from_cart',
        ecommerce: {
          currency: 'USD',
          value: parseFloat(itemToRemove.price) * itemToRemove.qty,
          items: [{
            item_id: itemToRemove.id.toString(),
            item_name: itemToRemove.name,
            category: itemToRemove.type,
            price: parseFloat(itemToRemove.price),
            quantity: itemToRemove.qty
          }]
        }
      })
      
      console.log('GTM remove_from_cart event sent:', {
        item_name: itemToRemove.name,
        item_id: itemToRemove.id,
        quantity: itemToRemove.qty
      })
    }
    
    // 執行移除操作
    cartStore.removeFromCart(itemId)
  }
}

// 開始結帳
const goToCheckout = () =&gt; {
  // 發送 GTM 事件 - 開始結帳
  if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
    window.dataLayer.push({
      event: 'begin_checkout',
      ecommerce: {
        currency: 'USD',
        value: parseFloat(totalPrice.value),
        items: items.map(item =&gt; ({
          item_id: item.id.toString(),
          item_name: item.name,
          category: item.type,
          price: parseFloat(item.price),
          quantity: item.qty
        }))
      }
    })
    
    console.log('GTM begin_checkout event sent:', {
      total_value: totalPrice.value,
      item_count: items.length
    })
  }
  
  // 導向結帳頁面
  router.push('/checkout')
}

const totalPrice = computed(() =&gt; {
  return items.reduce((total, item) =&gt; total + (item.price * item.qty), 0)
})
&lt;/script&gt;
</div></code></pre>
<h3 id="4-%E8%B7%AF%E7%94%B1%E8%BF%BD%E8%B9%A4---%E9%A0%81%E9%9D%A2%E7%80%8F%E8%A6%BD%E4%BA%8B%E4%BB%B6-routerindexjs">4. 路由追蹤 - 頁面瀏覽事件 (router/index.js)</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// ... 路由配置</span>

<span class="hljs-keyword">const</span> router = createRouter({
  <span class="hljs-attr">history</span>: createWebHashHistory(),
  <span class="hljs-attr">routes</span>: [
    <span class="hljs-comment">// ... 路由定義</span>
  ]
})

<span class="hljs-comment">// GTM 頁面追蹤</span>
router.afterEach(<span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> {
  <span class="hljs-comment">// 確保 GTM dataLayer 存在</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.dataLayer) {
    <span class="hljs-comment">// 發送頁面瀏覽事件到 GTM</span>
    <span class="hljs-built_in">window</span>.dataLayer.push({
      <span class="hljs-attr">event</span>: <span class="hljs-string">'page_view'</span>,
      <span class="hljs-attr">page_title</span>: to.meta?.title || <span class="hljs-built_in">document</span>.title,
      <span class="hljs-attr">page_location</span>: <span class="hljs-built_in">window</span>.location.href,
      <span class="hljs-attr">page_path</span>: to.path
    })
    
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'GTM page_view event sent:'</span>, {
      <span class="hljs-attr">page_path</span>: to.path,
      <span class="hljs-attr">page_title</span>: to.meta?.title || <span class="hljs-built_in">document</span>.title
    })
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</div></code></pre>
<h3 id="5-%E7%B5%90%E5%B8%B3%E9%A0%81%E9%9D%A2---%E5%AE%8C%E6%88%90%E8%B3%BC%E8%B2%B7-checkoutpagevue">5. 結帳頁面 - 完成購買 (CheckoutPage.vue)</h3>
<pre class="hljs"><code><div>&lt;script&gt;
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useCartStore } from '../store/cart'

export default {
  name: 'CheckoutPage',
  setup() {
    const router = useRouter()
    const cartStore = useCartStore()
    const { items, clearCart } = cartStore
    
    const formData = ref({
      name: '',
      address: '',
      phone: ''
    })
    
    const totalPrice = computed(() =&gt; {
      return items.reduce((total, item) =&gt; total + (item.price * item.qty), 0)
    })
    
    // 提交訂單並發送 Purchase 事件
    const submitOrder = async () =&gt; {
      try {
        // 生成唯一訂單編號
        const transactionId = 'ORDER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
        
        // 發送 GTM Purchase 事件
        if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
          window.dataLayer.push({
            event: 'purchase',
            ecommerce: {
              transaction_id: transactionId,
              currency: 'USD',
              value: parseFloat(totalPrice.value),
              items: items.map(item =&gt; ({
                item_id: item.id.toString(),
                item_name: item.name,
                category: item.type,
                price: parseFloat(item.price),
                quantity: item.qty
              }))
            },
            // 額外的訂單資訊
            customer_info: {
              name: formData.value.name,
              phone: formData.value.phone
            }
          })
          
          console.log('GTM purchase event sent:', {
            transaction_id: transactionId,
            total_value: totalPrice.value,
            item_count: items.length,
            customer_name: formData.value.name
          })
        }
        
        // 模擬 API 調用
        await new Promise(resolve =&gt; setTimeout(resolve, 1500))
        
        // 清空購物車
        clearCart()
        
        // 導向成功頁面
        router.push('/order-success')
        
      } catch (error) {
        console.error('訂單提交失敗:', error)
      }
    }
    
    return {
      formData,
      totalPrice,
      submitOrder,
      items
    }
  }
}
&lt;/script&gt;
</div></code></pre>
<h3 id="6-%E7%99%BB%E5%85%A5%E8%A8%BB%E5%86%8A%E9%A0%81%E9%9D%A2---%E7%94%A8%E6%88%B6%E8%A8%BB%E5%86%8A%E8%BF%BD%E8%B9%A4-loginpagevue">6. 登入/註冊頁面 - 用戶註冊追蹤 (LoginPage.vue)</h3>
<pre class="hljs"><code><div>&lt;script&gt;
import { ref, computed } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useUserStore } from '../store/user'

export default {
  name: 'LoginPage',
  setup() {
    const router = useRouter()
    const route = useRoute()
    const userStore = useUserStore()
    
    const usernameInput = ref('')
    const isLoading = ref(false)
    const isNewUser = ref(false) // 追蹤是否為新用戶
    
    // 處理登入/註冊
    const handleLogin = async () =&gt; {
      if (!canSubmit.value) return
      
      isLoading.value = true
      
      // 檢查是否為新用戶（模擬檢查邏輯）
      const isFirstTimeLogin = !localStorage.getItem(`user_${usernameInput.value}_visited`)
      
      setTimeout(() =&gt; {
        const result = userStore.login(usernameInput.value)
        
        if (result.success) {
          // 如果是新用戶，發送註冊完成事件
          if (isFirstTimeLogin) {
            // 標記用戶已訪問
            localStorage.setItem(`user_${usernameInput.value}_visited`, 'true')
            
            // 發送 GTM 註冊事件
            if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
              window.dataLayer.push({
                event: 'sign_up',
                user_data: {
                  username: usernameInput.value,
                  registration_method: 'website',
                  registration_type: 'manual',
                  is_first_time: true
                },
                // 可選：如果有註冊獎勵
                ecommerce: {
                  currency: 'USD',
                  value: 0, // 註冊獎勵金額
                  items: [] // 如果有贈送商品
                }
              })
              
              console.log('GTM sign_up event sent:', {
                username: usernameInput.value,
                registration_method: 'website',
                timestamp: new Date().toISOString()
              })
            }
            
            isNewUser.value = true
          } else {
            // 現有用戶登入，發送登入事件
            if (typeof window !== 'undefined' &amp;&amp; window.dataLayer) {
              window.dataLayer.push({
                event: 'login',
                user_data: {
                  username: usernameInput.value,
                  login_method: 'website',
                  is_returning_user: true
                }
              })
              
              console.log('GTM login event sent:', {
                username: usernameInput.value,
                login_method: 'website'
              })
            }
          }
          
          // 登入成功後的導向
          const redirectTo = route.query.redirect || '/'
          router.push(redirectTo)
        } else {
          errorMessage.value = result.message
        }
        
        isLoading.value = false
      }, 500)
    }
    
    return {
      usernameInput,
      isLoading,
      isNewUser,
      handleLogin
      // ... 其他返回值
    }
  }
}
&lt;/script&gt;
</div></code></pre>
<h2 id="%F0%9F%94%A7-gtm-%E8%A8%AD%E5%AE%9A%E6%8C%87%E5%8D%97">🔧 GTM 設定指南</h2>
<h3 id="gtm-%E8%AE%8A%E6%95%B8%E8%A8%AD%E5%AE%9A">GTM 變數設定</h3>
<p>在 GTM 後台建立以下資料層變數 (Data Layer Variable)：</p>
<h4 id="%E9%9B%BB%E5%95%86%E4%BA%8B%E4%BB%B6%E8%AE%8A%E6%95%B8">電商事件變數</h4>
<table>
<thead>
<tr>
<th>變數名稱</th>
<th>變數類型</th>
<th>資料層變數名稱</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DLV - Item ID</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items.0.item_id</code></td>
<td>商品 ID</td>
</tr>
<tr>
<td><code>DLV - Item Name</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items.0.item_name</code></td>
<td>商品名稱</td>
</tr>
<tr>
<td><code>DLV - Item Price</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items.0.price</code></td>
<td>商品價格</td>
</tr>
<tr>
<td><code>DLV - Item Category</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items.0.category</code></td>
<td>商品類別</td>
</tr>
<tr>
<td><code>DLV - Item Quantity</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items.0.quantity</code></td>
<td>商品數量</td>
</tr>
<tr>
<td><code>DLV - Ecommerce Value</code></td>
<td>資料層變數</td>
<td><code>ecommerce.value</code></td>
<td>交易總值</td>
</tr>
<tr>
<td><code>DLV - Currency</code></td>
<td>資料層變數</td>
<td><code>ecommerce.currency</code></td>
<td>幣別</td>
</tr>
<tr>
<td><code>DLV - Transaction ID</code></td>
<td>資料層變數</td>
<td><code>ecommerce.transaction_id</code></td>
<td>交易訂單編號</td>
</tr>
<tr>
<td><code>DLV - Ecommerce Items</code></td>
<td>資料層變數</td>
<td><code>ecommerce.items</code></td>
<td>購物車商品陣列</td>
</tr>
</tbody>
</table>
<h4 id="%E8%87%AA%E8%A8%82-javascript-%E8%AE%8A%E6%95%B8-%E9%9C%80%E8%A6%81%E5%85%88%E5%BB%BA%E7%AB%8B-dlv---ecommerce-items">自訂 JavaScript 變數 (需要先建立 DLV - Ecommerce Items)</h4>
<table>
<thead>
<tr>
<th>變數名稱</th>
<th>變數類型</th>
<th>JavaScript 代碼</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DLV - Cart Items Count</code></td>
<td>自訂 JavaScript</td>
<td><code>function(){var items={{DLV - Ecommerce Items}};return items?items.length:0;}</code></td>
<td>購物車商品數量</td>
</tr>
<tr>
<td><code>DLV - Cart Item IDs</code></td>
<td>自訂 JavaScript</td>
<td><code>function(){var items={{DLV - Ecommerce Items}};return items?items.map(function(item){return item.item_id;}):[]; }</code></td>
<td>購物車所有商品 ID 陣列</td>
</tr>
</tbody>
</table>
<h4 id="%E7%94%A8%E6%88%B6%E4%BA%8B%E4%BB%B6%E8%AE%8A%E6%95%B8">用戶事件變數</h4>
<table>
<thead>
<tr>
<th>變數名稱</th>
<th>變數類型</th>
<th>資料層變數名稱</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DLV - Username</code></td>
<td>資料層變數</td>
<td><code>user_data.username</code></td>
<td>用戶名</td>
</tr>
<tr>
<td><code>DLV - Registration Method</code></td>
<td>資料層變數</td>
<td><code>user_data.registration_method</code></td>
<td>註冊方式 (website, social, email)</td>
</tr>
<tr>
<td><code>DLV - Registration Type</code></td>
<td>資料層變數</td>
<td><code>user_data.registration_type</code></td>
<td>註冊類型 (manual, auto, invited)</td>
</tr>
<tr>
<td><code>DLV - User Registration Type</code></td>
<td>資料層變數</td>
<td><code>user_data.registration_method</code></td>
<td>用於 OneAD Pixel 的註冊類型</td>
</tr>
<tr>
<td><code>DLV - Registration Value</code></td>
<td>資料層變數</td>
<td><code>ecommerce.value</code></td>
<td>註冊獎勵價值</td>
</tr>
<tr>
<td><code>DLV - Is First Time</code></td>
<td>資料層變數</td>
<td><code>user_data.is_first_time</code></td>
<td>是否為首次註冊</td>
</tr>
<tr>
<td><code>DLV - Login Method</code></td>
<td>資料層變數</td>
<td><code>user_data.login_method</code></td>
<td>登入方式</td>
</tr>
</tbody>
</table>
<h3 id="gtm-%E8%A7%B8%E7%99%BC%E6%A2%9D%E4%BB%B6%E8%A8%AD%E5%AE%9A">GTM 觸發條件設定</h3>
<p>建立以下自訂事件觸發條件：</p>
<h4 id="%E9%9B%BB%E5%95%86%E4%BA%8B%E4%BB%B6%E8%A7%B8%E7%99%BC%E6%A2%9D%E4%BB%B6">電商事件觸發條件</h4>
<table>
<thead>
<tr>
<th>觸發條件名稱</th>
<th>觸發條件類型</th>
<th>條件設定</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Trigger - Add to Cart</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>add_to_cart</code></td>
</tr>
<tr>
<td><code>Trigger - Remove from Cart</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>remove_from_cart</code></td>
</tr>
<tr>
<td><code>Trigger - View Item</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>view_item</code></td>
</tr>
<tr>
<td><code>Trigger - Begin Checkout</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>begin_checkout</code></td>
</tr>
<tr>
<td><code>Trigger - Purchase</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>purchase</code></td>
</tr>
<tr>
<td><code>Trigger - Page View</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>page_view</code></td>
</tr>
</tbody>
</table>
<h4 id="%E7%94%A8%E6%88%B6%E4%BA%8B%E4%BB%B6%E8%A7%B8%E7%99%BC%E6%A2%9D%E4%BB%B6">用戶事件觸發條件</h4>
<table>
<thead>
<tr>
<th>觸發條件名稱</th>
<th>觸發條件類型</th>
<th>條件設定</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Trigger - Sign Up</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>sign_up</code></td>
</tr>
<tr>
<td><code>Trigger - Login</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>login</code></td>
</tr>
<tr>
<td><code>Trigger - First Time Registration</code></td>
<td>自訂事件</td>
<td>事件名稱等於 <code>sign_up</code> AND <code>{{DLV - Is First Time}}</code> 等於 <code>true</code></td>
</tr>
</tbody>
</table>
<h3 id="onead-pixel-%E6%95%B4%E5%90%88">OneAD Pixel 整合</h3>
<p>OneAD Pixel 也支援電商事件追蹤，以下是對照表：</p>
<table>
<thead>
<tr>
<th>GTM Event</th>
<th>OneAD Pixel Event</th>
<th>參數格式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>add_to_cart</code></td>
<td><code>AddToCart</code></td>
<td><code>{ content_ids, content_name, content_category, value, currency }</code></td>
</tr>
<tr>
<td><code>view_item</code></td>
<td><code>ViewContent</code></td>
<td><code>{ content_ids, content_name, content_category, content_type }</code></td>
</tr>
<tr>
<td><code>begin_checkout</code></td>
<td><code>InitiateCheckout</code></td>
<td><code>{ value, currency, num_items, content_ids }</code></td>
</tr>
<tr>
<td><code>purchase</code></td>
<td><code>Purchase</code></td>
<td><code>{ content_ids, value, currency, transaction_id, num_items }</code></td>
</tr>
<tr>
<td><code>sign_up</code></td>
<td><code>CompleteRegistration</code></td>
<td><code>{ status, content_name }</code></td>
</tr>
</tbody>
</table>
<h4 id="onead-pixel-%E4%BB%A3%E7%A2%BC%E7%AF%84%E4%BE%8B">OneAD Pixel 代碼範例：</h4>
<pre class="hljs"><code><div><span class="hljs-comment">&lt;!-- AddToCart 事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onep !== <span class="hljs-string">'undefined'</span>) {
  onep(<span class="hljs-string">'track'</span>, <span class="hljs-string">'AddToCart'</span>, {
    content_ids: [<span class="hljs-string">'{{DLV - Item ID}}'</span>],
    content_name: <span class="hljs-string">'{{DLV - Item Name}}'</span>,
    content_category: <span class="hljs-string">'{{DLV - Item Category}}'</span>,
    content_type: <span class="hljs-string">'product'</span>,
    value: {{DLV - Item Price}},
    currency: <span class="hljs-string">'USD'</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ViewContent 事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onep !== <span class="hljs-string">'undefined'</span>) {
  onep(<span class="hljs-string">'track'</span>, <span class="hljs-string">'ViewContent'</span>, {
    content_ids: [<span class="hljs-string">'{{DLV - Item ID}}'</span>],
    content_name: <span class="hljs-string">'{{DLV - Item Name}}'</span>,
    content_category: <span class="hljs-string">'{{DLV - Item Category}}'</span>,
    content_type: <span class="hljs-string">'product'</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- InitiateCheckout 事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onep !== <span class="hljs-string">'undefined'</span>) {
  onep(<span class="hljs-string">'track'</span>, <span class="hljs-string">'InitiateCheckout'</span>, {
    content_ids: {{DLV - Cart Item IDs}}, <span class="hljs-comment">// 陣列格式: ['1', '2', '3']</span>
    value: {{DLV - Ecommerce Value}},
    currency: <span class="hljs-string">'USD'</span>,
    num_items: {{DLV - Cart Items Count}}
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Purchase 事件 (完成購買) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onep !== <span class="hljs-string">'undefined'</span>) {
  onep(<span class="hljs-string">'track'</span>, <span class="hljs-string">'Purchase'</span>, {
    <span class="hljs-attr">content_ids</span>: {{DLV - Cart Item IDs}}, <span class="hljs-comment">// 所有購買商品的 ID 陣列</span>
    <span class="hljs-attr">value</span>: {{DLV - Ecommerce Value}},     <span class="hljs-comment">// 交易總金額</span>
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,                      <span class="hljs-comment">// 幣別</span>
    <span class="hljs-attr">transaction_id</span>: <span class="hljs-string">'{{DLV - Transaction ID}}'</span>, <span class="hljs-comment">// 訂單編號</span>
    <span class="hljs-attr">num_items</span>: {{DLV - Cart Items Count}} <span class="hljs-comment">// 購買商品總數</span>
  });
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'OneAD Pixel Purchase fired:'</span>, {
    <span class="hljs-attr">transaction_id</span>: <span class="hljs-string">'{{DLV - Transaction ID}}'</span>,
    <span class="hljs-attr">value</span>: {{DLV - Ecommerce Value}},
    <span class="hljs-attr">num_items</span>: {{DLV - Cart Items Count}}
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- CompleteRegistration 事件 (註冊完成) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onep !== <span class="hljs-string">'undefined'</span>) {
  onep(<span class="hljs-string">'track'</span>, <span class="hljs-string">'CompleteRegistration'</span>, {
    <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>,                        <span class="hljs-comment">// 註冊狀態</span>
    <span class="hljs-attr">content_name</span>: <span class="hljs-string">'{{DLV - User Registration Type}}'</span>, <span class="hljs-comment">// 註冊類型 (如：'website', 'email', 'social')</span>
    <span class="hljs-comment">// 可選參數</span>
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,                          <span class="hljs-comment">// 如果有註冊獎勵金額</span>
    <span class="hljs-attr">value</span>: {{DLV - Registration Value}}       <span class="hljs-comment">// 註冊獎勵價值</span>
  });
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'OneAD Pixel CompleteRegistration fired:'</span>, {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'{{DLV - Username}}'</span>,
    <span class="hljs-attr">registration_type</span>: <span class="hljs-string">'{{DLV - User Registration Type}}'</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h3 id="facebook-pixel-%E4%BA%8B%E4%BB%B6%E5%B0%8D%E7%85%A7%E8%A1%A8">Facebook Pixel 事件對照表</h3>
<p>本表格整理了 GTM Data Layer 事件與 Facebook Pixel 標準事件的對應關係：</p>
<table>
<thead>
<tr>
<th>GTM Event</th>
<th>Facebook Pixel Event</th>
<th>說明</th>
<th>觸發時機</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>add_to_cart</code></td>
<td><code>AddToCart</code></td>
<td>加入購物車</td>
<td>使用者點擊「加入購物車」按鈕</td>
</tr>
<tr>
<td><code>remove_from_cart</code></td>
<td><em>(自訂事件)</em></td>
<td>移除購物車</td>
<td>使用者在購物車頁面移除商品</td>
</tr>
<tr>
<td><code>view_item</code></td>
<td><code>ViewContent</code></td>
<td>查看內容</td>
<td>使用者進入產品詳細頁面</td>
</tr>
<tr>
<td><code>begin_checkout</code></td>
<td><code>InitiateCheckout</code></td>
<td>開始結帳</td>
<td>使用者點擊「結帳」按鈕</td>
</tr>
<tr>
<td><code>purchase</code></td>
<td><code>Purchase</code></td>
<td>完成購買</td>
<td>使用者完成訂單提交</td>
</tr>
<tr>
<td><code>sign_up</code></td>
<td><code>CompleteRegistration</code></td>
<td>完成註冊</td>
<td>使用者完成帳號註冊</td>
</tr>
<tr>
<td><code>login</code></td>
<td><em>(自訂事件)</em></td>
<td>用戶登入</td>
<td>使用者登入帳號</td>
</tr>
<tr>
<td><code>page_view</code></td>
<td><code>PageView</code></td>
<td>頁面瀏覽</td>
<td>自動追蹤頁面載入</td>
</tr>
</tbody>
</table>
<h3 id="facebook-pixel-%E5%8F%83%E6%95%B8%E5%B0%8D%E7%85%A7%E8%A1%A8">Facebook Pixel 參數對照表</h3>
<h4 id="%E9%9B%BB%E5%95%86%E4%BA%8B%E4%BB%B6%E5%8F%83%E6%95%B8">電商事件參數</h4>
<table>
<thead>
<tr>
<th>參數用途</th>
<th>GTM 變數</th>
<th>Facebook Pixel 參數</th>
<th>資料類型</th>
<th>範例值</th>
</tr>
</thead>
<tbody>
<tr>
<td>商品 ID</td>
<td><code>{{DLV - Item ID}}</code></td>
<td><code>content_ids</code></td>
<td>Array</td>
<td><code>['1']</code></td>
</tr>
<tr>
<td>商品名稱</td>
<td><code>{{DLV - Item Name}}</code></td>
<td><code>content_name</code></td>
<td>String</td>
<td><code>'可樂'</code></td>
</tr>
<tr>
<td>商品類別</td>
<td><code>{{DLV - Item Category}}</code></td>
<td><code>content_category</code></td>
<td>String</td>
<td><code>'飲料'</code></td>
</tr>
<tr>
<td>商品價格</td>
<td><code>{{DLV - Item Price}}</code></td>
<td><code>value</code></td>
<td>Number</td>
<td><code>30.00</code></td>
</tr>
<tr>
<td>幣別</td>
<td><code>'USD'</code></td>
<td><code>currency</code></td>
<td>String</td>
<td><code>'USD'</code></td>
</tr>
<tr>
<td>內容類型</td>
<td><code>'product'</code></td>
<td><code>content_type</code></td>
<td>String</td>
<td><code>'product'</code></td>
</tr>
<tr>
<td>數量</td>
<td><code>{{DLV - Item Quantity}}</code></td>
<td><code>num_items</code></td>
<td>Number</td>
<td><code>1</code></td>
</tr>
</tbody>
</table>
<h4 id="%E7%94%A8%E6%88%B6%E4%BA%8B%E4%BB%B6%E5%8F%83%E6%95%B8">用戶事件參數</h4>
<table>
<thead>
<tr>
<th>參數用途</th>
<th>GTM 變數</th>
<th>Facebook Pixel 參數</th>
<th>資料類型</th>
<th>範例值</th>
</tr>
</thead>
<tbody>
<tr>
<td>註冊方式</td>
<td><code>{{DLV - Registration Method}}</code></td>
<td><code>content_name</code></td>
<td>String</td>
<td><code>'website'</code></td>
</tr>
<tr>
<td>註冊狀態</td>
<td><code>'success'</code></td>
<td><code>status</code></td>
<td>String</td>
<td><code>'success'</code></td>
</tr>
<tr>
<td>註冊獎勵值</td>
<td><code>{{DLV - Registration Value}}</code></td>
<td><code>value</code></td>
<td>Number</td>
<td><code>0</code></td>
</tr>
<tr>
<td>幣別</td>
<td><code>'USD'</code></td>
<td><code>currency</code></td>
<td>String</td>
<td><code>'USD'</code></td>
</tr>
</tbody>
</table>
<h3 id="%E7%AC%AC%E4%B8%89%E6%96%B9%E8%BF%BD%E8%B9%A4%E4%BB%A3%E7%A2%BC%E7%AF%84%E4%BE%8B">第三方追蹤代碼範例</h3>
<h4 id="1-addtocart-%E4%BA%8B%E4%BB%B6-%E5%8A%A0%E5%85%A5%E8%B3%BC%E7%89%A9%E8%BB%8A">1. AddToCart 事件 (加入購物車)</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'track'</span>, <span class="hljs-string">'AddToCart'</span>, {
    content_ids: [<span class="hljs-string">'{{DLV - Item ID}}'</span>],
    content_name: <span class="hljs-string">'{{DLV - Item Name}}'</span>,
    content_category: <span class="hljs-string">'{{DLV - Item Category}}'</span>,
    content_type: <span class="hljs-string">'product'</span>,
    value: {{DLV - Item Price}},
    currency: <span class="hljs-string">'USD'</span>,
    num_items: <span class="hljs-number">1</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="2-viewcontent-%E4%BA%8B%E4%BB%B6-%E6%9F%A5%E7%9C%8B%E5%95%86%E5%93%81">2. ViewContent 事件 (查看商品)</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'track'</span>, <span class="hljs-string">'ViewContent'</span>, {
    content_ids: [<span class="hljs-string">'{{DLV - Item ID}}'</span>],
    content_name: <span class="hljs-string">'{{DLV - Item Name}}'</span>,
    content_category: <span class="hljs-string">'{{DLV - Item Category}}'</span>,
    content_type: <span class="hljs-string">'product'</span>,
    value: {{DLV - Item Price}},
    currency: <span class="hljs-string">'USD'</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="3-initiatecheckout-%E4%BA%8B%E4%BB%B6-%E9%96%8B%E5%A7%8B%E7%B5%90%E5%B8%B3">3. InitiateCheckout 事件 (開始結帳)</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'track'</span>, <span class="hljs-string">'InitiateCheckout'</span>, {
    content_ids: {{DLV - Cart Item IDs}}, <span class="hljs-comment">// 陣列格式: ['1', '2', '3']</span>
    value: {{DLV - Ecommerce Value}},
    currency: <span class="hljs-string">'USD'</span>,
    num_items: {{DLV - Cart Items Count}}
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="4-purchase-%E4%BA%8B%E4%BB%B6-%E5%AE%8C%E6%88%90%E8%B3%BC%E8%B2%B7">4. Purchase 事件 (完成購買)</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'track'</span>, <span class="hljs-string">'Purchase'</span>, {
    <span class="hljs-attr">content_ids</span>: {{DLV - Cart Item IDs}}, <span class="hljs-comment">// 所有購買商品的 ID 陣列</span>
    <span class="hljs-attr">value</span>: {{DLV - Ecommerce Value}},     <span class="hljs-comment">// 交易總金額</span>
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,                      <span class="hljs-comment">// 幣別</span>
    <span class="hljs-attr">content_type</span>: <span class="hljs-string">'product'</span>,              <span class="hljs-comment">// 內容類型</span>
    <span class="hljs-attr">num_items</span>: {{DLV - Cart Items Count}}, <span class="hljs-comment">// 購買商品總數</span>
    <span class="hljs-comment">// 可選參數</span>
    <span class="hljs-attr">order_id</span>: <span class="hljs-string">'{{DLV - Transaction ID}}'</span>  <span class="hljs-comment">// 訂單編號</span>
  });
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Facebook Pixel Purchase fired:'</span>, {
    <span class="hljs-attr">transaction_id</span>: <span class="hljs-string">'{{DLV - Transaction ID}}'</span>,
    <span class="hljs-attr">value</span>: {{DLV - Ecommerce Value}},
    <span class="hljs-attr">num_items</span>: {{DLV - Cart Items Count}}
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="5-completeregistration-%E4%BA%8B%E4%BB%B6-%E5%AE%8C%E6%88%90%E8%A8%BB%E5%86%8A">5. CompleteRegistration 事件 (完成註冊)</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'track'</span>, <span class="hljs-string">'CompleteRegistration'</span>, {
    <span class="hljs-attr">content_name</span>: <span class="hljs-string">'{{DLV - Registration Method}}'</span>, <span class="hljs-comment">// 註冊方式</span>
    <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>,                             <span class="hljs-comment">// 註冊狀態</span>
    <span class="hljs-attr">value</span>: {{DLV - Registration Value}},           <span class="hljs-comment">// 註冊獎勵價值 (如果有)</span>
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>                                <span class="hljs-comment">// 幣別</span>
  });
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Facebook Pixel CompleteRegistration fired:'</span>, {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'{{DLV - Username}}'</span>,
    <span class="hljs-attr">registration_method</span>: <span class="hljs-string">'{{DLV - Registration Method}}'</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="6-%E8%87%AA%E8%A8%82%E7%99%BB%E5%85%A5%E4%BA%8B%E4%BB%B6">6. 自訂登入事件</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'trackCustom'</span>, <span class="hljs-string">'UserLogin'</span>, {
    <span class="hljs-attr">content_name</span>: <span class="hljs-string">'{{DLV - Login Method}}'</span>,        <span class="hljs-comment">// 登入方式</span>
    <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span>                              <span class="hljs-comment">// 登入狀態</span>
  });
  
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Facebook Pixel UserLogin fired:'</span>, {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'{{DLV - Username}}'</span>,
    <span class="hljs-attr">login_method</span>: <span class="hljs-string">'{{DLV - Login Method}}'</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h4 id="7-%E8%87%AA%E8%A8%82%E7%A7%BB%E9%99%A4%E8%B3%BC%E7%89%A9%E8%BB%8A%E4%BA%8B%E4%BB%B6">7. 自訂移除購物車事件</h4>
<pre class="hljs"><code><div><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fbq !== <span class="hljs-string">'undefined'</span>) {
  fbq(<span class="hljs-string">'trackCustom'</span>, <span class="hljs-string">'RemoveFromCart'</span>, {
    content_ids: [<span class="hljs-string">'{{DLV - Item ID}}'</span>],
    content_name: <span class="hljs-string">'{{DLV - Item Name}}'</span>,
    content_category: <span class="hljs-string">'{{DLV - Item Category}}'</span>,
    content_type: <span class="hljs-string">'product'</span>,
    value: {{DLV - Item Price}},
    currency: <span class="hljs-string">'USD'</span>
  });
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</div></code></pre>
<h2 id="%F0%9F%A7%AA-%E6%B8%AC%E8%A9%A6%E8%88%87%E9%99%A4%E9%8C%AF">🧪 測試與除錯</h2>
<h3 id="1-%E7%80%8F%E8%A6%BD%E5%99%A8%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%B8%AC%E8%A9%A6">1. 瀏覽器控制台測試</h3>
<h4 id="%E6%AA%A2%E6%9F%A5-datalayer-%E7%8B%80%E6%85%8B">檢查 DataLayer 狀態</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// 檢查 dataLayer 是否存在</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'DataLayer exists:'</span>, <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span>.dataLayer !== <span class="hljs-string">'undefined'</span>);

<span class="hljs-comment">// 查看所有 dataLayer 事件</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'DataLayer contents:'</span>, <span class="hljs-built_in">window</span>.dataLayer);

<span class="hljs-comment">// 過濾特定事件</span>
<span class="hljs-built_in">window</span>.dataLayer.filter(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> event.event === <span class="hljs-string">'add_to_cart'</span>);
</div></code></pre>
<h4 id="%E6%89%8B%E5%8B%95%E6%B8%AC%E8%A9%A6%E4%BA%8B%E4%BB%B6%E6%8E%A8%E9%80%81">手動測試事件推送</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// 測試加入購物車事件</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">ecommerce</span>: {
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-number">30.00</span>,
    <span class="hljs-attr">items</span>: [{
      <span class="hljs-attr">item_id</span>: <span class="hljs-string">'1'</span>,
      <span class="hljs-attr">item_name</span>: <span class="hljs-string">'Test Product'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'Test Category'</span>,
      <span class="hljs-attr">price</span>: <span class="hljs-number">30.00</span>,
      <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span>
    }]
  }
});

<span class="hljs-comment">// 測試用戶註冊事件</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'sign_up'</span>,
  <span class="hljs-attr">user_data</span>: {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'testuser123'</span>,
    <span class="hljs-attr">registration_method</span>: <span class="hljs-string">'website'</span>,
    <span class="hljs-attr">registration_type</span>: <span class="hljs-string">'manual'</span>,
    <span class="hljs-attr">is_first_time</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">ecommerce</span>: {
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 註冊獎勵金額</span>
    <span class="hljs-attr">items</span>: []
  }
});

<span class="hljs-comment">// 測試用戶登入事件</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'login'</span>,
  <span class="hljs-attr">user_data</span>: {
    <span class="hljs-attr">username</span>: <span class="hljs-string">'existinguser456'</span>,
    <span class="hljs-attr">login_method</span>: <span class="hljs-string">'website'</span>,
    <span class="hljs-attr">is_returning_user</span>: <span class="hljs-literal">true</span>
  }
});

<span class="hljs-comment">// 驗證事件是否推送成功</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Last event:'</span>, <span class="hljs-built_in">window</span>.dataLayer[<span class="hljs-built_in">window</span>.dataLayer.length - <span class="hljs-number">1</span>]);
</div></code></pre>
<h3 id="2-gtm-preview-%E6%A8%A1%E5%BC%8F%E6%B8%AC%E8%A9%A6%E6%B5%81%E7%A8%8B">2. GTM Preview 模式測試流程</h3>
<h4 id="%E6%AD%A5%E9%A9%9F-1-%E5%95%9F%E7%94%A8-preview-%E6%A8%A1%E5%BC%8F">步驟 1: 啟用 Preview 模式</h4>
<ol>
<li>登入 GTM 後台</li>
<li>點擊右上角「預覽」按鈕</li>
<li>輸入網站 URL 開始除錯</li>
</ol>
<h4 id="%E6%AD%A5%E9%A9%9F-2-%E6%B8%AC%E8%A9%A6%E4%BA%8B%E4%BB%B6%E8%A7%B8%E7%99%BC">步驟 2: 測試事件觸發</h4>
<table>
<thead>
<tr>
<th>測試項目</th>
<th>執行動作</th>
<th>預期結果</th>
</tr>
</thead>
<tbody>
<tr>
<td>頁面載入</td>
<td>重新整理頁面</td>
<td>觸發 <code>page_view</code> 事件</td>
</tr>
<tr>
<td>商品瀏覽</td>
<td>點擊商品進入詳細頁</td>
<td>觸發 <code>view_item</code> 事件</td>
</tr>
<tr>
<td>加入購物車</td>
<td>點擊「加入購物車」按鈕</td>
<td>觸發 <code>add_to_cart</code> 事件</td>
</tr>
<tr>
<td>移除商品</td>
<td>在購物車頁面移除商品</td>
<td>觸發 <code>remove_from_cart</code> 事件</td>
</tr>
<tr>
<td>開始結帳</td>
<td>點擊「結帳」按鈕</td>
<td>觸發 <code>begin_checkout</code> 事件</td>
</tr>
<tr>
<td>完成購買</td>
<td>在結帳頁面提交訂單</td>
<td>觸發 <code>purchase</code> 事件</td>
</tr>
<tr>
<td>用戶註冊</td>
<td>首次登入新帳號</td>
<td>觸發 <code>sign_up</code> 事件</td>
</tr>
<tr>
<td>用戶登入</td>
<td>現有用戶登入</td>
<td>觸發 <code>login</code> 事件</td>
</tr>
</tbody>
</table>
<h4 id="%E6%AD%A5%E9%A9%9F-3-%E9%A9%97%E8%AD%89%E8%AE%8A%E6%95%B8%E5%80%BC">步驟 3: 驗證變數值</h4>
<p>在 GTM Preview 中檢查以下變數是否正確取值：</p>
<ul>
<li><code>{{DLV - Item ID}}</code> - 應顯示商品 ID</li>
<li><code>{{DLV - Item Name}}</code> - 應顯示商品名稱</li>
<li><code>{{DLV - Item Price}}</code> - 應顯示正確價格</li>
<li><code>{{DLV - Ecommerce Value}}</code> - 應顯示交易總值</li>
</ul>
<h3 id="3-%E7%AC%AC%E4%B8%89%E6%96%B9%E5%B7%A5%E5%85%B7%E9%A9%97%E8%AD%89">3. 第三方工具驗證</h3>
<h4 id="onead-pixel-%E6%B8%AC%E8%A9%A6">OneAD Pixel 測試</h4>
<ol>
<li>安裝 <a href="https://chromewebstore.google.com/detail/onead-tag-assistant/giclcphmgfdppppohhbfccocanhbdijd?utm_source=ext_app_menu">OneAD Pixel Helper</a> 瀏覽器擴充功能</li>
<li>執行購物操作並觀察 Pixel Helper 狀態</li>
</ol>
<h3 id="4-%E9%96%8B%E7%99%BC%E8%80%85%E5%B7%A5%E5%85%B7-network-%E6%AA%A2%E6%9F%A5">4. 開發者工具 Network 檢查</h3>
<h4 id="%E6%AA%A2%E6%9F%A5%E8%BF%BD%E8%B9%A4%E8%AB%8B%E6%B1%82">檢查追蹤請求</h4>
<p>OneAD 相關網域</p>
<ul>
<li>https://onead.onevision.com.tw/</li>
<li>https://pixel.onead.com.tw/</li>
</ul>
<h3 id="5-%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">5. 常見問題故障排除</h3>
<h3 id="5-%E5%B8%B8%E8%A6%8B%E5%95%8F%E9%A1%8C%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">5. 常見問題故障排除</h3>
<h4 id="%F0%9F%93%8B-gtm-%E8%AE%8A%E6%95%B8%E8%A8%AD%E5%AE%9A%E6%AD%A5%E9%A9%9F%E6%8C%87%E5%8D%97">📋 <strong>GTM 變數設定步驟指南</strong></h4>
<p><strong>步驟 1: 建立基礎資料層變數</strong></p>
<pre class="hljs"><code><div>變數 → 新增 → 選擇「資料層變數」
- 變數名稱: DLV - Ecommerce Items
- 資料層變數名稱: ecommerce.items
- 儲存
</div></code></pre>
<p><strong>步驟 2: 建立自訂 JavaScript 變數</strong></p>
<pre class="hljs"><code><div>變數 → 新增 → 選擇「自訂 JavaScript」
- 變數名稱: DLV - Cart Items Count
- 自訂 JavaScript:
function(){
  var items = {{DLV - Ecommerce Items}};
  return items ? items.length : 0;
}
- 儲存
</div></code></pre>
<pre class="hljs"><code><div>變數 → 新增 → 選擇「自訂 JavaScript」
- 變數名稱: DLV - Cart Item IDs
- 自訂 JavaScript:
function(){
  var items = {{DLV - Ecommerce Items}};
  return items ? items.map(function(item){
    return item.item_id;
  }) : [];
}
- 儲存
</div></code></pre>
<h4 id="q-%E8%AE%8A%E6%95%B8%E8%A8%AD%E5%AE%9A%E9%8C%AF%E8%AA%A4%E6%AA%A2%E6%9F%A5%E6%B8%85%E5%96%AE">Q: 變數設定錯誤檢查清單</h4>
<p><strong>必須按順序建立的變數：</strong></p>
<ol>
<li>
<p><strong>基礎資料層變數</strong> (先建立這些)</p>
<ul>
<li>✅ <code>DLV - Ecommerce Items</code> → <code>ecommerce.items</code></li>
<li>✅ <code>DLV - Ecommerce Value</code> → <code>ecommerce.value</code></li>
<li>✅ <code>DLV - Transaction ID</code> → <code>ecommerce.transaction_id</code></li>
</ul>
</li>
<li>
<p><strong>依賴變數</strong> (需要先有基礎變數)</p>
<ul>
<li>✅ <code>DLV - Cart Items Count</code> → 自訂 JS (依賴 DLV - Ecommerce Items)</li>
<li>✅ <code>DLV - Cart Item IDs</code> → 自訂 JS (依賴 DLV - Ecommerce Items)</li>
</ul>
</li>
</ol>
<p><strong>常見錯誤修正：</strong></p>
<ul>
<li>❌ <code>{{ecommerce.items}}</code> → ✅ <code>{{DLV - Ecommerce Items}}</code></li>
<li>❌ <code>DLV - Transaction Value</code> → ✅ <code>DLV - Ecommerce Value</code></li>
<li>❌ <code>[{{DLV - Cart Item IDs}}]</code> → ✅ <code>{{DLV - Cart Item IDs}}</code></li>
</ul>
<h4 id="q-datalayer-%E4%BA%8B%E4%BB%B6%E6%B2%92%E6%9C%89%E8%A7%B8%E7%99%BC">Q: DataLayer 事件沒有觸發</h4>
<p><strong>可能原因與解決方案：</strong></p>
<ol>
<li>
<p><strong>Vue 組件生命週期問題</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 確保在 DOM 更新後觸發</span>
<span class="hljs-keyword">this</span>.$nextTick(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-built_in">window</span>.dataLayer.push({...});
});
</div></code></pre>
</li>
<li>
<p><strong>GTM 代碼載入順序</strong></p>
<ul>
<li>確認 GTM 代碼在 <code>&lt;head&gt;</code> 中正確載入</li>
<li>檢查 noscript 版本是否在 <code>&lt;body&gt;</code> 開始處</li>
</ul>
</li>
<li>
<p><strong>事件名稱拼寫錯誤</strong></p>
<ul>
<li>確認 Vue.js 中的事件名稱與 GTM 觸發條件一致</li>
</ul>
</li>
</ol>
<h4 id="q-%E8%AE%8A%E6%95%B8%E5%80%BC%E7%82%BA-undefined">Q: 變數值為 undefined</h4>
<p><strong>檢查項目：</strong></p>
<ol>
<li>DataLayer 推送的資料結構是否正確</li>
<li>GTM 變數的資料層變數名稱是否準確</li>
<li>事件觸發時機是否正確</li>
</ol>
<h4 id="q-%E7%AC%AC%E4%B8%89%E6%96%B9-pixel-%E6%B2%92%E6%9C%89%E6%8E%A5%E6%94%B6%E5%88%B0%E4%BA%8B%E4%BB%B6">Q: 第三方 Pixel 沒有接收到事件</h4>
<p><strong>故障排除步驟：</strong></p>
<ol>
<li>檢查 GTM 代碼是否正確發布</li>
<li>確認觸發條件是否符合</li>
<li>檢查瀏覽器廣告攔截器設定</li>
<li>驗證第三方 Pixel 代碼語法</li>
</ol>
<h3 id="6-%E6%95%88%E8%83%BD%E7%9B%A3%E6%8E%A7">6. 效能監控</h3>
<h4 id="datalayer-%E5%A4%A7%E5%B0%8F%E7%9B%A3%E6%8E%A7">DataLayer 大小監控</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// 檢查 dataLayer 大小 (建議 &lt; 1MB)</span>
<span class="hljs-keyword">const</span> dataLayerSize = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">window</span>.dataLayer).length;
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'DataLayer size (bytes):'</span>, dataLayerSize);

<span class="hljs-comment">// 清理舊事件 (保留最近 100 個)</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.dataLayer.length &gt; <span class="hljs-number">100</span>) {
  <span class="hljs-built_in">window</span>.dataLayer.splice(<span class="hljs-number">0</span>, <span class="hljs-built_in">window</span>.dataLayer.length - <span class="hljs-number">100</span>);
}
</div></code></pre>
<h4 id="%E4%BA%8B%E4%BB%B6%E9%A0%BB%E7%8E%87%E7%9B%A3%E6%8E%A7">事件頻率監控</h4>
<pre class="hljs"><code><div><span class="hljs-comment">// 追蹤事件推送頻率</span>
<span class="hljs-keyword">let</span> eventCount = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> originalPush = <span class="hljs-built_in">window</span>.dataLayer.push;
<span class="hljs-built_in">window</span>.dataLayer.push = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  eventCount++;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Event #<span class="hljs-subst">${eventCount}</span>:`</span>, <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]);
  <span class="hljs-keyword">return</span> originalPush.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
};
</div></code></pre>
<h2 id="%F0%9F%93%9D-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85%E8%88%87%E6%9C%80%E4%BD%B3%E5%AF%A6%E5%8B%99">📝 注意事項與最佳實務</h2>
<h3 id="%F0%9F%94%92-%E8%B3%87%E6%96%99%E5%90%88%E8%A6%8F%E8%88%87%E9%9A%B1%E7%A7%81">🔒 資料合規與隱私</h3>
<ol>
<li>
<p><strong>GDPR / CCPA 合規</strong></p>
<ul>
<li>在歐盟或加州使用者訪問前，需取得追蹤同意</li>
<li>實作 Consent Management Platform (CMP)</li>
<li>提供資料使用透明度說明</li>
</ul>
</li>
<li>
<p><strong>資料最小化原則</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// ❌ 避免傳送敏感資料</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">user_email</span>: <span class="hljs-string">'user@example.com'</span>, <span class="hljs-comment">// 不要傳送 PII</span>
  <span class="hljs-attr">user_phone</span>: <span class="hljs-string">'+1234567890'</span>        <span class="hljs-comment">// 不要傳送 PII</span>
});

<span class="hljs-comment">// ✅ 只傳送必要的商業資料</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">ecommerce</span>: {
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,
    <span class="hljs-attr">value</span>: <span class="hljs-number">30.00</span>,
    <span class="hljs-attr">items</span>: [{ <span class="hljs-comment">/* 商品資料 */</span> }]
  }
});
</div></code></pre>
</li>
</ol>
<h3 id="%E2%9A%A1-%E6%95%88%E8%83%BD%E5%84%AA%E5%8C%96">⚡ 效能優化</h3>
<ol>
<li>
<p><strong>資料型別優化</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// ✅ 確保數值型別正確</span>
<span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(product.price),        <span class="hljs-comment">// 數字</span>
<span class="hljs-attr">item_id</span>: product.id.toString(),          <span class="hljs-comment">// 字串</span>
<span class="hljs-attr">quantity</span>: <span class="hljs-built_in">parseInt</span>(item.qty)             <span class="hljs-comment">// 整數</span>
</div></code></pre>
</li>
<li>
<p><strong>事件去重機制</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 防止重複點擊造成多次事件</span>
<span class="hljs-keyword">let</span> isEventSent = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">const</span> addToCart = <span class="hljs-function">(<span class="hljs-params">product</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isEventSent) {
    isEventSent = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">window</span>.dataLayer.push({...});
    
    <span class="hljs-comment">// 2秒後重置，允許下次操作</span>
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { isEventSent = <span class="hljs-literal">false</span>; }, <span class="hljs-number">2000</span>);
  }
};
</div></code></pre>
</li>
<li>
<p><strong>條件載入</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 只在必要時載入追蹤代碼</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.dataLayer) {
  <span class="hljs-built_in">window</span>.dataLayer.push({...});
}
</div></code></pre>
</li>
</ol>
<h3 id="%F0%9F%8F%97%EF%B8%8F-%E7%A8%8B%E5%BC%8F%E6%9E%B6%E6%A7%8B%E5%BB%BA%E8%AD%B0">🏗️ 程式架構建議</h3>
<ol>
<li>
<p><strong>統一事件管理</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 建立統一的追蹤管理類別</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrackingManager</span> </span>{
  <span class="hljs-keyword">static</span> trackEvent(eventName, eventData) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.dataLayer) {
      <span class="hljs-built_in">window</span>.dataLayer.push({
        <span class="hljs-attr">event</span>: eventName,
        ...eventData
      });
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[Tracking] <span class="hljs-subst">${eventName}</span>:`</span>, eventData);
    }
  }

  <span class="hljs-keyword">static</span> trackEcommerce(event, ecommerceData) {
    <span class="hljs-keyword">this</span>.trackEvent(event, { <span class="hljs-attr">ecommerce</span>: ecommerceData });
  }
}

<span class="hljs-comment">// 使用範例</span>
TrackingManager.trackEcommerce(<span class="hljs-string">'add_to_cart'</span>, {
  <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>,
  <span class="hljs-attr">value</span>: <span class="hljs-number">30.00</span>,
  <span class="hljs-attr">items</span>: [{ <span class="hljs-comment">/* 商品資料 */</span> }]
});
</div></code></pre>
</li>
<li>
<p><strong>Vue.js Mixin 模式</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// tracking-mixin.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> trackingMixin = {
  <span class="hljs-attr">methods</span>: {
    $track(eventName, data) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.dataLayer) {
        <span class="hljs-built_in">window</span>.dataLayer.push({
          <span class="hljs-attr">event</span>: eventName,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString(),
          ...data
        });
      }
    }
  }
};

<span class="hljs-comment">// 在組件中使用</span>
<span class="hljs-keyword">import</span> { trackingMixin } <span class="hljs-keyword">from</span> <span class="hljs-string">'./mixins/tracking-mixin'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">mixins</span>: [trackingMixin],
  <span class="hljs-attr">methods</span>: {
    addToCart(product) {
      <span class="hljs-keyword">this</span>.$track(<span class="hljs-string">'add_to_cart'</span>, {
        <span class="hljs-attr">ecommerce</span>: { <span class="hljs-comment">/* 資料 */</span> }
      });
    }
  }
};
</div></code></pre>
</li>
</ol>
<h3 id="%F0%9F%9A%80-%E9%83%A8%E7%BD%B2%E8%88%87%E7%B6%AD%E8%AD%B7">🚀 部署與維護</h3>
<ol>
<li>
<p><strong>環境區分</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 根據環境使用不同的 GTM 容器</span>
<span class="hljs-keyword">const</span> GTM_ID = process.env.NODE_ENV === <span class="hljs-string">'production'</span> 
  ? <span class="hljs-string">'GTM-PROD-123'</span> 
  : <span class="hljs-string">'GTM-DEV-456'</span>;
</div></code></pre>
</li>
<li>
<p><strong>版本控制</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 在事件中加入版本資訊</span>
<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">tracking_version</span>: <span class="hljs-string">'1.2.0'</span>,
  <span class="hljs-attr">ecommerce</span>: { <span class="hljs-comment">/* 資料 */</span> }
});
</div></code></pre>
</li>
<li>
<p><strong>錯誤監控</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 追蹤錯誤到 DataLayer</span>
<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'error'</span>, (event) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.dataLayer) {
    <span class="hljs-built_in">window</span>.dataLayer.push({
      <span class="hljs-attr">event</span>: <span class="hljs-string">'javascript_error'</span>,
      <span class="hljs-attr">error_message</span>: event.message,
      <span class="hljs-attr">error_filename</span>: event.filename,
      <span class="hljs-attr">error_lineno</span>: event.lineno
    });
  }
});
</div></code></pre>
</li>
</ol>
<h3 id="%F0%9F%93%8A-%E6%88%90%E6%95%88%E7%9B%A3%E6%8E%A7%E6%8C%87%E6%A8%99">📊 成效監控指標</h3>
<h4 id="%E6%8A%80%E8%A1%93%E6%8C%87%E6%A8%99">技術指標</h4>
<ul>
<li><strong>事件成功率</strong>: 事件觸發數 / 使用者操作數</li>
<li><strong>資料完整性</strong>: 包含必要參數的事件百分比</li>
<li><strong>延遲時間</strong>: 從使用者操作到事件發送的時間</li>
</ul>
<h4 id="%E6%A5%AD%E5%8B%99%E6%8C%87%E6%A8%99">業務指標</h4>
<ul>
<li><strong>轉換漏斗</strong>: PageView → ViewContent → AddToCart → InitiateCheckout → Purchase</li>
<li><strong>購物車放棄率</strong>: (AddToCart - Purchase) / AddToCart</li>
<li><strong>商品熱門度</strong>: 各商品的 ViewContent 和 AddToCart 次數</li>
</ul>
<h3 id="%F0%9F%94%84-%E6%8C%81%E7%BA%8C%E5%84%AA%E5%8C%96">🔄 持續優化</h3>
<ol>
<li>
<p><strong>A/B 測試整合</strong></p>
<pre class="hljs"><code><div><span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">ab_test_variant</span>: <span class="hljs-string">'checkout_button_v2'</span>,
  <span class="hljs-attr">ecommerce</span>: { <span class="hljs-comment">/* 資料 */</span> }
});
</div></code></pre>
</li>
<li>
<p><strong>使用者旅程追蹤</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment">// 記錄使用者的完整購物旅程</span>
<span class="hljs-keyword">const</span> userJourney = {
  <span class="hljs-attr">session_id</span>: <span class="hljs-string">'unique_session_id'</span>,
  <span class="hljs-attr">user_segment</span>: <span class="hljs-string">'returning_customer'</span>,
  <span class="hljs-attr">traffic_source</span>: <span class="hljs-string">'google_ads'</span>
};

<span class="hljs-built_in">window</span>.dataLayer.push({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'add_to_cart'</span>,
  <span class="hljs-attr">user_journey</span>: userJourney,
  <span class="hljs-attr">ecommerce</span>: { <span class="hljs-comment">/* 資料 */</span> }
});
</div></code></pre>
</li>
</ol>
<h2 id="%F0%9F%94%97-%E7%9B%B8%E9%97%9C%E8%B3%87%E6%BA%90%E8%88%87%E6%96%87%E4%BB%B6">🔗 相關資源與文件</h2>
<h3 id="%E5%AE%98%E6%96%B9%E6%96%87%E4%BB%B6">官方文件</h3>
<ul>
<li><strong><a href="https://developers.google.com/tag-manager">Google Tag Manager 開發者指南</a></strong></li>
<li><strong><a href="https://developers.google.com/analytics/devguides/collection/ga4/ecommerce">GA4 電商事件參考</a></strong></li>
<li><strong><a href="https://developers.facebook.com/docs/meta-pixel/reference">Facebook Pixel 參考文件</a></strong></li>
<li><strong><a href="https://vuejs.org/guide/essentials/lifecycle.html">Vue.js 生命週期指南</a></strong></li>
</ul>
<h3 id="%E6%B8%AC%E8%A9%A6%E5%B7%A5%E5%85%B7">測試工具</h3>
<ul>
<li><strong><a href="https://tagmanager.google.com/">GTM Preview Mode</a></strong></li>
<li><strong><a href="https://chrome.google.com/webstore/detail/facebook-pixel-helper/fdgfkebogiimcoedlicjlajpkdmockpc">Facebook Pixel Helper</a></strong></li>
<li><strong><a href="https://analytics.google.com/">GA4 Real-time 報告</a></strong></li>
<li><strong><a href="https://chrome.google.com/webstore/detail/tag-assistant-legacy-by/kejbdjndbnbjgmefkgdddjlbokphdefk">Tag Assistant Legacy</a></strong></li>
</ul>
<h3 id="%E5%AD%B8%E7%BF%92%E8%B3%87%E6%BA%90">學習資源</h3>
<ul>
<li><strong><a href="https://analytics.google.com/analytics/academy/">Google Analytics Academy</a></strong></li>
<li><strong><a href="https://www.facebookblueprint.com/">Facebook Blueprint</a></strong></li>
<li><strong><a href="https://support.google.com/tagmanager/answer/6107163">GTM 最佳實務指南</a></strong></li>
</ul>
<h3 id="%E5%90%88%E8%A6%8F%E5%B7%A5%E5%85%B7">合規工具</h3>
<ul>
<li><strong><a href="https://developers.google.com/tag-platform/security/consent-mode">Google Consent Mode</a></strong></li>
<li><strong><a href="https://developers.facebook.com/docs/meta-pixel/advanced/advanced-matching">Facebook Advanced Matching</a></strong></li>
<li><strong><a href="https://gdpr.eu/checklist/">GDPR 合規檢查清單</a></strong></li>
</ul>
<hr>
<p><em>此文件基於 Vue.js 3 + Pinia + Vue Router 的電商專案架構編寫</em></p>

</body>
</html>
